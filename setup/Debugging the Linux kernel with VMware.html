<!DOCTYPE html>
<!-- saved from url=(0045)https://xakcop.com/post/vmw-kernel-debugging/ -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.59.1">

  <title>Debugging the Linux kernel with VMware · random hacks</title>

    

  
  
  <link rel="stylesheet" href="./Debugging the Linux kernel with VMware_files/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="./Debugging the Linux kernel with VMware_files/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="./Debugging the Linux kernel with VMware_files/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="./Debugging the Linux kernel with VMware_files/blackburn.css">

  
  <link rel="stylesheet" href="./Debugging the Linux kernel with VMware_files/font-awesome.min.css">

  
  <link href="./Debugging the Linux kernel with VMware_files/css" rel="stylesheet" type="text/css">

  
  <script src="./Debugging the Linux kernel with VMware_files/MathJax.js"></script><style></style>

 
  

  
  <link rel="stylesheet" href="./Debugging the Linux kernel with VMware_files/github.min.css">
  <script src="./Debugging the Linux kernel with VMware_files/highlight.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://xakcop.com//favicon.ico" type="image/x-icon">


  
  

<style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck.RTL {right: .7em; left: auto}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style></head>


<body><div id="MathJax_Message" style="display: none;"></div>
<div id="layout">

  
<a href="https://xakcop.com/post/vmw-kernel-debugging/#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  

  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://xakcop.com/"><i class="fa fa-home fa-fw"></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://xakcop.com/post/"><i class="fa fa-list fa-fw"></i>Posts</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/rgerganov" rel="me" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/rgerganov" rel="me" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/rgerganov" rel="me" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>© 2016-2019. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Debugging the Linux kernel with VMware</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>07 Mar 2019, 16:33</time>
  </div>

  

  
  
  
  

  
  
  
  

</div>

  

<p>I am playing with emulated HID devices in Linux and found a kernel bug when using the <code>usb_f_hid</code> and <code>dummy_hcd</code> kernel modules.
I won’t go into details of what I am trying to achieve (saving this for a future post) but focus on how I troubleshooted this
particular bug. As of this writing, it is 100% reproducible with 4.15.0-45 kernel and these steps:</p>

<ol>
<li>Load <code>libcomposite</code> and <code>dummy_hcd</code> into the kernel</li>
<li>Create an emulated HID device with configfs</li>
<li>Write something to <code>/dev/hidg0</code></li>
</ol>

<p>After executing step 3, the machine hangs in a way which makes it clear that it’s not a userspace problem but a kernel one.</p>

<p>I know that <a href="https://www.vmware.com/products/workstation-pro.html">VMware Workstation</a> has support for kernel debugging, so
I thought this is a great chance to give it a try.
I loaded Ubuntu 18.04 into a VM and executed the steps above. The VM hanged and the corresponding <code>vmware-vmx</code> process in the
host OS went to 100% CPU usage. This means that when the problem occurs, the kernel goes into some kind of busy loop.
Let’s see how we can debug this further.</p>

<h2 id="vm-config">VM config</h2>

<p>VMware Workstation has a nice feature which allows to debug the Linux kernel running inside the VM with <code>gdb</code> on the host.
This is enabled by adding a single line to the VM’s configuration file:</p>

<pre><code class="hljs apache"><span class="hljs-attribute">debugStub</span>.listen.guest64 = <span class="hljs-string">"TRUE"</span>
</code></pre>

<p>Now when the VM is started, port 8864 is opened on the host and we can connect to it with <code>gdb</code> for remote debugging.</p>

<h2 id="preparing-the-guest-os">Preparing the guest OS</h2>

<p>First, we want to disable <a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization">KASLR</a>
as it will make the debugging harder. This is done by booting the kernel with the <code>nokaslr</code> option.</p>

<p>Open <code>/etc/default/grub</code>, find the line starting with <code>GRUB_CMDLINE_LINUX_DEFAULT</code> and append <code>nokaslr</code> at the end.
Then update GRUB:</p>

<p><code>sudo update-grub</code></p>

<p>and reboot the VM.</p>

<p>Next, we want to obtain debug symbols for the running kernel and its modules.
For Ubuntu there is a dedicated <a href="https://wiki.ubuntu.com/Debug%20Symbol%20Packages#Getting_-dbgsym.ddeb_packages">repository</a>:</p>

<pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">"deb http://ddebs.ubuntu.com <span class="hljs-variable">$(lsb_release -cs)</span> main restricted universe multiverse
deb http://ddebs.ubuntu.com <span class="hljs-variable">$(lsb_release -cs)</span>-updates main restricted universe multiverse
deb http://ddebs.ubuntu.com <span class="hljs-variable">$(lsb_release -cs)</span>-proposed main restricted universe multiverse"</span> | \
sudo tee -a /etc/apt/sources.list.d/ddebs.list
sudo apt install ubuntu-dbgsym-keyring
sudo apt-get update
</code></pre>

<p>Install kernel with debug symbols:</p>

<pre><code class="hljs sql">sudo apt-get <span class="hljs-keyword">install</span> linux-image-<span class="hljs-string">`uname -r`</span>-dbgsym
</code></pre>

<p>Copy the following files to the host OS as we need to load them into <code>gdb</code>:</p>

<pre><code class="hljs bash">/usr/lib/debug/boot/vmlinux-4.15.0-45-generic
/usr/lib/debug/lib/modules/4.15.0-45-generic/kernel/drivers/usb/gadget/udc/udc-core.ko
/usr/lib/debug/lib/modules/4.15.0-45-generic/kernel/drivers/usb/gadget/<span class="hljs-keyword">function</span>/usb_f_hid.ko
dummy_hcd.ko
</code></pre>

<p><em>Note</em>: <code>dummy_hcd</code> is missing in Ubuntu (see this <a href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1073089">bug</a>), I built it by myself.</p>

<h2 id="using-gdb">Using GDB</h2>

<p>Now that we have the debug symbols, we are ready to fire off <code>gdb</code> in the host OS:</p>

<pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> gdb vmlinux-4.15.0-45-generic</span>

(gdb) set architecture i386:x86-64
(gdb) target remote localhost:8864
(gdb) c
</code></pre>

<p>Hitting Ctrl+C will pause the VM:</p>

<p><a href="https://xakcop.com/images/debug-vm.png" title="debugvm">
</a></p><div class="pure-u-1-1"><a href="https://xakcop.com/images/debug-vm.png" title="debugvm">
  <img class="pure-img" src="./Debugging the Linux kernel with VMware_files/debug-vm-small.png" alt="debugvm">
</a></div><a href="https://xakcop.com/images/debug-vm.png" title="debugvm">
</a><p></p>

<p>so we can inspect the state in the debugger.</p>

<p>We also need to load the symbols for the kernel modules that we want to debug.
However, modules can be dynamically loaded at any address and we need to feed this information into <code>gdb</code>.
Let’s take for example <code>usb_f_hid</code>. We can get the corresponding addresses in the guest OS like this:</p>

<pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> <span class="hljs-built_in">cd</span> /sys/module/usb_f_hid/sections</span>
<span class="hljs-meta">$</span><span class="bash"> sudo cat .text .data .bss </span>
0xffffffffc06d7000
0xffffffffc06da000
0xffffffffc06da740
</code></pre>

<p>Now we can add the symbol file in <code>gdb</code> using the addresses from above:</p>

<pre><code class="hljs css">(<span class="hljs-selector-tag">gdb</span>) <span class="hljs-selector-tag">add-symbol-file</span> <span class="hljs-selector-tag">usb_f_hid</span><span class="hljs-selector-class">.ko</span> 0<span class="hljs-selector-tag">xffffffffc06d7000</span> <span class="hljs-selector-tag">-s</span> <span class="hljs-selector-class">.data</span> 0<span class="hljs-selector-tag">xffffffffc06da000</span> <span class="hljs-selector-tag">-s</span> <span class="hljs-selector-class">.bss</span> 0<span class="hljs-selector-tag">xffffffffc06da740</span>
</code></pre>

<p>We do the same for <code>udc-core</code> and <code>dummy_hcd</code>.
Now that we have all symbols loaded, we can trigger the bug in the guest OS and then hit Ctrl+C in <code>gdb</code> to
inspect the backtrace:</p>

<pre><code class="hljs shell">^C
Program received signal SIGINT, Interrupt.
0xffffffff810de405 in rep_nop () at /build/linux-uQJ2um/linux-4.15.0/arch/x86/include/asm/processor.h:647
647 /build/linux-uQJ2um/linux-4.15.0/arch/x86/include/asm/processor.h: No such file or directory.
(gdb) bt
<span class="hljs-meta">#</span><span class="bash">0  0xffffffff810de405 <span class="hljs-keyword">in</span> rep_nop () at /build/linux-uQJ2um/linux-4.15.0/arch/x86/include/asm/processor.h:647</span>
<span class="hljs-meta">#</span><span class="bash">1  cpu_relax () at /build/linux-uQJ2um/linux-4.15.0/arch/x86/include/asm/processor.h:652</span>
<span class="hljs-meta">#</span><span class="bash">2  virt_spin_lock (lock=&lt;optimized out&gt;) at /build/linux-uQJ2um/linux-4.15.0/arch/x86/include/asm/qspinlock.h:69</span>
<span class="hljs-meta">#</span><span class="bash">3  native_queued_spin_lock_slowpath (lock=0xffff88007196984c, val=1) at /build/linux-uQJ2um/linux-4.15.0/kernel/locking/qspinlock.c:305</span>
<span class="hljs-meta">#</span><span class="bash">4  0xffffffff8199f407 <span class="hljs-keyword">in</span> pv_queued_spin_lock_slowpath (val=&lt;optimized out&gt;, lock=&lt;optimized out&gt;) at /build/linux-uQJ2um/linux-4.15.0/arch/x86/include/asm/paravirt.h:669</span>
<span class="hljs-meta">#</span><span class="bash">5  queued_spin_lock_slowpath (val=&lt;optimized out&gt;, lock=&lt;optimized out&gt;) at /build/linux-uQJ2um/linux-4.15.0/arch/x86/include/asm/qspinlock.h:30</span>
<span class="hljs-meta">#</span><span class="bash">6  queued_spin_lock (lock=&lt;optimized out&gt;) at /build/linux-uQJ2um/linux-4.15.0/include/asm-generic/qspinlock.h:90</span>
<span class="hljs-meta">#</span><span class="bash">7  do_raw_spin_lock_flags (flags=&lt;optimized out&gt;, lock=&lt;optimized out&gt;) at /build/linux-uQJ2um/linux-4.15.0/include/linux/spinlock.h:172</span>
<span class="hljs-meta">#</span><span class="bash">8  __raw_spin_lock_irqsave (lock=&lt;optimized out&gt;) at /build/linux-uQJ2um/linux-4.15.0/include/linux/spinlock_api_smp.h:119</span>
<span class="hljs-meta">#</span><span class="bash">9  _raw_spin_lock_irqsave (lock=0xffff88007196984c) at /build/linux-uQJ2um/linux-4.15.0/kernel/locking/spinlock.c:152</span>
<span class="hljs-meta">#</span><span class="bash">10 0xffffffffc06d7410 <span class="hljs-keyword">in</span> f_hidg_req_complete (ep=&lt;optimized out&gt;, req=&lt;optimized out&gt;) at /build/linux-uQJ2um/linux-4.15.0/drivers/usb/gadget/<span class="hljs-keyword">function</span>/f_hid.c:328</span>
<span class="hljs-meta">#</span><span class="bash">11 0xffffffffc06a390a <span class="hljs-keyword">in</span> usb_gadget_giveback_request ()</span>
<span class="hljs-meta">#</span><span class="bash">12 0xffffffffc06cdff2 <span class="hljs-keyword">in</span> dummy_queue ()</span>
<span class="hljs-meta">#</span><span class="bash">13 0xffffffffc06a2b96 <span class="hljs-keyword">in</span> usb_ep_queue ()</span>
<span class="hljs-meta">#</span><span class="bash">14 0xffffffffc06d7eb6 <span class="hljs-keyword">in</span> f_hidg_write (file=&lt;optimized out&gt;, buffer=&lt;optimized out&gt;, count=5, offp=&lt;optimized out&gt;) at /build/linux-uQJ2um/linux-4.15.0/drivers/usb/gadget/<span class="hljs-keyword">function</span>/f_hid.c:394</span>
<span class="hljs-meta">#</span><span class="bash">15 0xffffffff8127730b <span class="hljs-keyword">in</span> __vfs_write (file=&lt;optimized out&gt;, p=&lt;optimized out&gt;, count=&lt;optimized out&gt;, pos=&lt;optimized out&gt;) at /build/linux-uQJ2um/linux-4.15.0/fs/read_write.c:481</span>
<span class="hljs-meta">#</span><span class="bash">16 0xffffffff812774d1 <span class="hljs-keyword">in</span> vfs_write (file=0xffff880077b77c00, buf=0x55841858c7c0 <span class="hljs-string">"fira\n"</span>, count=&lt;optimized out&gt;, pos=0xffffc90000bbbef8) at /build/linux-uQJ2um/linux-4.15.0/fs/read_write.c:569</span>
<span class="hljs-meta">#</span><span class="bash">17 0xffffffff81277725 <span class="hljs-keyword">in</span> SYSC_write (count=&lt;optimized out&gt;, buf=&lt;optimized out&gt;, fd=&lt;optimized out&gt;) at /build/linux-uQJ2um/linux-4.15.0/fs/read_write.c:615</span>
<span class="hljs-meta">#</span><span class="bash">18 SyS_write (fd=&lt;optimized out&gt;, buf=94025832515520, count=5) at /build/linux-uQJ2um/linux-4.15.0/fs/read_write.c:607</span>
<span class="hljs-meta">#</span><span class="bash">19 0xffffffff81003ae3 <span class="hljs-keyword">in</span> do_syscall_64 ()</span>
<span class="hljs-meta">#</span><span class="bash">20 0xffffffff81a00081 <span class="hljs-keyword">in</span> entry_SYSCALL_64 () at /build/linux-uQJ2um/linux-4.15.0/arch/x86/entry/entry_64.S:237</span>
<span class="hljs-meta">#</span><span class="bash">21 0x00007f8e8d85d760 <span class="hljs-keyword">in</span> ?? ()</span>
<span class="hljs-meta">#</span><span class="bash">22 0x00007f8e8d85e2a0 <span class="hljs-keyword">in</span> ?? ()</span>
<span class="hljs-meta">#</span><span class="bash">23 0x0000000000000005 <span class="hljs-keyword">in</span> irq_stack_union ()</span>
Backtrace stopped: previous frame inner to this frame (corrupt stack?)
</code></pre>

<p>This reveals a deadlock involving <code>hidg-&gt;write_spinlock</code> in <code>f_hid.c</code> which explains why the CPU goes to 100% when the bug occurs.
The spinlock is acquired in the <code>f_hidg_write()</code> function before calling <code>usb_ep_queue()</code> which callbacks to <code>f_hidg_req_complete()</code> which
tries to acquire the same spinlock again.</p>

<p>My attempt to fix this bug is this <a href="https://www.spinics.net/lists/linux-usb/msg177735.html">patch</a> which I submitted to the maintainers of the USB subsytem.
Let’s see how that goes :)</p>

<p><strong>UPDATE:</strong> My patch has been <a href="https://github.com/torvalds/linux/commit/072684e8c58d17e853f8e8b9f6d9ce2e58d2b036">merged</a> in Linux 5.1-rc3</p>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://xakcop.com/post/ctrl-air-purifier/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://xakcop.com/post/ctrl-air-purifier/">Controlling my Air Purifier</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://xakcop.com/post/root-hs6020/">Rooting HS6020 IPTV STB</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://xakcop.com/post/root-hs6020/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

</div>

</div>
</div>
<script src="./Debugging the Linux kernel with VMware_files/ui.js"></script>
<script src="./Debugging the Linux kernel with VMware_files/menus.js"></script>









</body></html>